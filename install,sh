#!/usr/bin/env bash
set -euo pipefail

API_URL_DEFAULT="https://madhost.pw"
GITHUB_USER="Hamrusy"
GITHUB_REPO="madagent"

CONFIG_PATH="/etc/madagent.json"
BIN_PATH="/usr/local/bin/madagent"
UNIT_PATH="/etc/systemd/system/madagent.service"
GLIBC_TARGET="/opt/glibc-2.34"

NODE_ID=""
NODE_TOKEN=""
API_URL="$API_URL_DEFAULT"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --node-id)
      NODE_ID="$2"
      shift 2
      ;;
    --token)
      NODE_TOKEN="$2"
      shift 2
      ;;
    --api-url)
      API_URL="$2"
      shift 2
      ;;
    *)
      echo "Неизвестный аргумент: $1"
      echo "Использование: install.sh --node-id <id> --token <token> [--api-url <url>]"
      exit 1
      ;;
  esac
done

if [[ -z "$NODE_ID" || -z "$NODE_TOKEN" ]]; then
  echo "Использование: install.sh --node-id <id> --token <token> [--api-url <url>]"
  exit 1
fi

if [[ "$EUID" -ne 0 ]]; then
  echo "Этот скрипт нужно запускать от root (или через sudo)."
  exit 1
fi

echo "[*] Установка агента MadHost для узла: $NODE_ID"
echo "[*] API URL (куда шлём метрики): $API_URL"

ARCH="$(uname -m)"
case "$ARCH" in
  x86_64|amd64)
    AGENT_ARCH="linux-amd64"
    ;;
  aarch64|arm64)
    AGENT_ARCH="linux-arm64"
    ;;
  *)
    echo "Неподдерживаемая архитектура: $ARCH"
    exit 1
    ;;
esac

# --- определяем версию glibc ---
GLIBC_VER=""

if command -v getconf >/dev/null 2>&1; then
  GLIBC_VER=$(getconf GNU_LIBC_VERSION 2>/dev/null | awk '{print $2}' || true)
fi

if [[ -z "${GLIBC_VER}" ]] && command -v ldd >/dev/null 2>&1; then
  GLIBC_VER=$(ldd --version 2>/dev/null | head -n1 | sed -E 's/.* //')
fi

version_ge() {
  # usage: version_ge "2.34" "2.32"  -> 0 (true) если 2.34 >= 2.32
  [ "$(printf '%s\n%s\n' "$1" "$2" | sort -V | head -n1)" = "$2" ]
}

NEED_EXTRA_GLIBC=false

if [[ -n "${GLIBC_VER}" ]]; then
  if version_ge "${GLIBC_VER}" "2.32"; then
    echo "[*] Обнаружен glibc ${GLIBC_VER} (>= 2.32), дополнительная glibc не требуется."
  else
    echo "[*] Обнаружен glibc ${GLIBC_VER} (< 2.32), будет установлена glibc 2.34 в ${GLIBC_TARGET}."
    NEED_EXTRA_GLIBC=true
  fi
else
  echo "[*] Не удалось определить версию glibc, считаем что дополнительная glibc не нужна."
fi

AGENT_URL="https://github.com/${GITHUB_USER}/${GITHUB_REPO}/releases/latest/download/madagent-${AGENT_ARCH}"

echo "[*] Скачиваю бинарник агента: $AGENT_URL"
if command -v curl >/dev/null 2>&1; then
  curl -fsSL "$AGENT_URL" -o "$BIN_PATH"
elif command -v wget >/dev/null 2>&1; then
  wget -qO "$BIN_PATH" "$AGENT_URL"
else
  echo "Ошибка: ни curl, ни wget не найдены."
  exit 1
fi

chmod +x "$BIN_PATH"

if ! file "$BIN_PATH" | grep -q 'ELF 64-bit'; then
  echo "Ошибка: скачан не ELF-бинарник. Возможно, GitHub вернул HTML/ошибку."
  echo "Проверь вручную: $AGENT_URL"
  exit 1
fi

# --- установка дополнительной glibc при необходимости ---
install_extra_glibc() {
  if [[ -d "$GLIBC_TARGET" ]]; then
    echo "[*] glibc 2.34 уже установлена в ${GLIBC_TARGET}, пропускаю сборку."
    return 0
  fi

  echo "[*] Устанавливаю зависимости для сборки glibc 2.34 (development tools)..."

  if command -v dnf >/dev/null 2>&1; then
    dnf -y groupinstall "Development Tools" || true
    dnf -y install wget bison patch || true
  elif command -v yum >/dev/null 2>&1; then
    yum -y groupinstall "Development Tools" || true
    yum -y install wget bison patch || true
  elif command -v apt-get >/dev/null 2>&1; then
    apt-get update || true
    apt-get install -y build-essential wget bison gawk || true
  elif command -v zypper >/dev/null 2>&1; then
    zypper install -y -t pattern devel_basis || true
    zypper install -y wget bison || true
  else
    echo "[!] Не удалось автоматически установить зависимости для сборки glibc (неизвестный пакетный менеджер)."
    echo "    Попробую продолжить, но сборка может упасть."
  fi

  echo "[*] Скачиваю и собираю glibc 2.34 в ${GLIBC_TARGET} (это может занять время)..."

  TMPDIR_GLIBC="$(mktemp -d /tmp/glibc-XXXXXX)"
  cd "$TMPDIR_GLIBC"

  wget -q https://ftp.gnu.org/gnu/libc/glibc-2.34.tar.gz
  tar xf glibc-2.34.tar.gz
  mkdir glibc-build
  cd glibc-build

  ../glibc-2.34/configure --prefix="${GLIBC_TARGET}" --disable-werror
  make -j"$(nproc)"
  make install

  cd /
  rm -rf "$TMPDIR_GLIBC"

  echo "[*] glibc 2.34 установлена в ${GLIBC_TARGET}"
}

if [[ "$NEED_EXTRA_GLIBC" == true ]]; then
  install_extra_glibc

  echo "[*] Настраиваю wrapper для запуска madagent с glibc 2.34"

  if [[ -f "${BIN_PATH}.real" ]]; then
    rm -f "${BIN_PATH}.real"
  fi

  mv "$BIN_PATH" "${BIN_PATH}.real"

  cat > "$BIN_PATH" <<EOF
#!/usr/bin/env bash
export LD_LIBRARY_PATH="${GLIBC_TARGET}/lib:\${LD_LIBRARY_PATH:-}"
exec "${BIN_PATH}.real" "\$@"
EOF

  chmod +x "$BIN_PATH"
fi

echo "[*] Пишу конфиг в $CONFIG_PATH"
mkdir -p "$(dirname "$CONFIG_PATH")"

cat > "$CONFIG_PATH" <<EOF
{
  "api_url": "$API_URL",
  "node_id": "$NODE_ID",
  "token": "$NODE_TOKEN"
}
EOF

chmod 600 "$CONFIG_PATH"

echo "[*] Настраиваю systemd юнит в $UNIT_PATH"

cat > "$UNIT_PATH" <<'EOF'
[Unit]
Description=MadHost node metrics agent
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/usr/local/bin/madagent
Restart=always
RestartSec=5
Environment=MADAGENT_CONFIG=/etc/madagent.json

[Install]
WantedBy=multi-user.target
EOF

echo "[*] Перезапуск systemd daemon и запуск сервиса"
systemctl daemon-reload
systemctl enable --now madagent

sleep 2

if systemctl is-active --quiet madagent; then
  systemctl --no-pager --full status madagent || true
  echo
  echo "[✓] Агент установлен и запущен."
  echo "    Конфиг:   $CONFIG_PATH"
  echo "    Бинарник: $BIN_PATH"
else
  systemctl --no-pager --full status madagent || true
  echo
  echo "[!] Агент установлен, но не удалось запустить (см. лог выше / journalctl -u madagent)."
  echo "    Конфиг:   $CONFIG_PATH"
  echo "    Бинарник: $BIN_PATH"
  exit 1
fi
