#!/usr/bin/env bash
set -euo pipefail

API_URL_DEFAULT="https://madhost.pw"
GITHUB_USER="Hamrusy"
GITHUB_REPO="madagent"

CONFIG_PATH="/etc/madagent.json"
BIN_PATH="/usr/local/bin/madagent"
UNIT_PATH="/etc/systemd/system/madagent.service"

NODE_ID=""
NODE_TOKEN=""
API_URL="$API_URL_DEFAULT"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --node-id)
      NODE_ID="$2"
      shift 2
      ;;
    --token)
      NODE_TOKEN="$2"
      shift 2
      ;;
    --api-url)
      API_URL="$2"
      shift 2
      ;;
    *)
      echo "Неизвестный аргумент: $1"
      echo "Использование: install.sh --node-id <id> --token <token> [--api-url <url>]"
      exit 1
      ;;
  esac
done

if [[ -z "$NODE_ID" || -z "$NODE_TOKEN" ]]; then
  echo "Использование: install.sh --node-id <id> --token <token> [--api-url <url>]"
  exit 1
fi

if [[ "$EUID" -ne 0 ]]; then
  echo "Этот скрипт нужно запускать от root (или через sudo)."
  exit 1
fi

echo "[*] Установка агента MadHost для узла: $NODE_ID"
echo "[*] API URL (куда шлём метрики): $API_URL"

ARCH="$(uname -m)"
case "$ARCH" in
  x86_64|amd64)
    AGENT_ARCH="linux-amd64"
    ;;
  aarch64|arm64)
    AGENT_ARCH="linux-arm64"
    ;;
  *)
    echo "Неподдерживаемая архитектура: $ARCH"
    exit 1
    ;;
esac

# --- определяем версию glibc ---
GLIBC_VER=""

if command -v getconf >/dev/null 2>&1; then
  GLIBC_VER=$(getconf GNU_LIBC_VERSION 2>/dev/null | awk '{print $2}' || true)
fi

if [[ -z "${GLIBC_VER}" ]] && command -v ldd >/dev/null 2>&1; then
  GLIBC_VER=$(ldd --version 2>/dev/null | head -n1 | sed -E 's/.* //')
fi

version_ge() {
  # usage: version_ge "2.34" "2.32"  -> 0 (true) если 2.34 >= 2.32
  [ "$(printf '%s\n%s\n' "$1" "$2" | sort -V | head -n1)" = "$2" ]
}

AGENT_FLAVOUR="$AGENT_ARCH"

if [[ -n "${GLIBC_VER}" ]]; then
  if version_ge "${GLIBC_VER}" "2.32"; then
    echo "[*] Обнаружен glibc ${GLIBC_VER} (>= 2.32), используем стандартный бинарник."
  else
    echo "[*] Обнаружен glibc ${GLIBC_VER} (< 2.32), используем бинарник для старых систем."
    AGENT_FLAVOUR="${AGENT_ARCH}-legacy"
  fi
else
  echo "[*] Не удалось определить версию glibc, используем стандартный бинарник."
fi

AGENT_URL="https://github.com/${GITHUB_USER}/${GITHUB_REPO}/releases/latest/download/madagent-${AGENT_FLAVOUR}"

echo "[*] Скачиваю бинарник агента: $AGENT_URL"
if command -v curl >/dev/null 2>&1; then
  curl -fsSL "$AGENT_URL" -o "$BIN_PATH"
elif command -v wget >/dev/null 2>&1; then
  wget -qO "$BIN_PATH" "$AGENT_URL"
else
  echo "Ошибка: ни curl, ни wget не найдены."
  exit 1
fi

chmod +x "$BIN_PATH"

if ! file "$BIN_PATH" | grep -q 'ELF 64-bit'; then
  echo "Ошибка: скачан не ELF-бинарник. Возможно, GitHub вернул HTML/ошибку."
  echo "Проверь вручную: $AGENT_URL"
  exit 1
fi

echo "[*] Пишу конфиг в $CONFIG_PATH"
mkdir -p "$(dirname "$CONFIG_PATH")"

cat > "$CONFIG_PATH" <<EOF
{
  "api_url": "$API_URL",
  "node_id": "$NODE_ID",
  "token": "$NODE_TOKEN"
}
EOF

chmod 600 "$CONFIG_PATH"

echo "[*] Настраиваю systemd юнит в $UNIT_PATH"

cat > "$UNIT_PATH" <<'EOF'
[Unit]
Description=MadHost node metrics agent
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/usr/local/bin/madagent
Restart=always
RestartSec=5
Environment=MADAGENT_CONFIG=/etc/madagent.json

[Install]
WantedBy=multi-user.target
EOF

echo "[*] Перезапуск systemd daemon и запуск сервиса"
systemctl daemon-reload
systemctl enable --now madagent

sleep 2

if systemctl is-active --quiet madagent; then
  systemctl --no-pager --full status madagent || true
  echo
  echo "[✓] Агент установлен и запущен."
  echo "    Конфиг:   $CONFIG_PATH"
  echo "    Бинарник: $BIN_PATH"
else
  systemctl --no-pager --full status madagent || true
  echo
  echo "[!] Агент установлен, но не удалось запустить (см. лог выше / journalctl -u madagent)."
  echo "    Конфиг:   $CONFIG_PATH"
  echo "    Бинарник: $BIN_PATH"
  exit 1
fi
