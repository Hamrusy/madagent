#!/usr/bin/env bash
set -euo pipefail

API_URL_DEFAULT="https://madhost.pw"
GITHUB_USER="Hamrusy"
GITHUB_REPO="madagent"

CONFIG_PATH="/etc/madagent.json"
BIN_PATH="/usr/local/bin/madagent"
UNIT_PATH="/etc/systemd/system/madagent.service"

NODE_ID=""
NODE_TOKEN=""
API_URL="$API_URL_DEFAULT"
UPDATE=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --node-id)
      NODE_ID="$2"
      shift 2
      ;;
    --token)
      NODE_TOKEN="$2"
      shift 2
      ;;
    --api-url)
      API_URL="$2"
      shift 2
      ;;
    --update)
      UPDATE=true
      shift 1
      ;;
    *)
      echo "Неизвестный аргумент: $1"
      echo "Использование:"
      echo "  Установка: $0 --node-id <id> --token <token> [--api-url <url>]"
      echo "  Обновление: $0 --update"
      exit 1
      ;;
  esac
done

if [[ "$EUID" -ne 0 ]]; then
  echo "Этот скрипт нужно запускать от root (или через sudo)."
  exit 1
fi

ARCH="$(uname -m)"
case "$ARCH" in
  x86_64|amd64)
    AGENT_ARCH="linux-amd64"
    ;;
  aarch64|arm64)
    AGENT_ARCH="linux-arm64"
    ;;
  *)
    echo "Неподдерживаемая архитектура: $ARCH"
    exit 1
    ;;
esac

AGENT_URL="https://github.com/${GITHUB_USER}/${GITHUB_REPO}/releases/latest/download/madagent-${AGENT_ARCH}"

download_binary() {
  echo "[*] Скачиваю бинарник агента: $AGENT_URL"

  local tmp_path="${BIN_PATH}.new"

  if command -v curl >/dev/null 2>&1; then
    curl -fsSL "$AGENT_URL" -o "$tmp_path"
  elif command -v wget >/dev/null 2>&1; then
    wget -qO "$tmp_path" "$AGENT_URL"
  else
    echo "Ошибка: ни curl, ни wget не найдены."
    exit 1
  fi

  chmod +x "$tmp_path"

  if ! file "$tmp_path" | grep -q 'ELF 64-bit'; then
    echo "Ошибка: скачан не ELF-бинарник. Возможно, GitHub вернул HTML/ошибку."
    echo "Проверь вручную: $AGENT_URL"
    rm -f "$tmp_path"
    exit 1
  fi

  # На случай старых установок с madagent.real — просто выпилим его
  if [[ -f "${BIN_PATH}.real" ]]; then
    echo "[*] Обнаружен старый madagent.real, удаляю (переход на статичный бинарь)"
    rm -f "${BIN_PATH}.real"
  fi

  mv "$tmp_path" "$BIN_PATH"
  echo "[*] Новый бинарник установлен в $BIN_PATH"
}

if [[ "$UPDATE" == true ]]; then
  echo "[*] Режим обновления агента (без изменения конфига и systemd юнита)"

  download_binary

  echo "[*] Перезапускаю сервис madagent"
  systemctl daemon-reload || true
  systemctl restart madagent

  sleep 1

  if systemctl is-active --quiet madagent; then
    systemctl --no-pager --full status madagent || true
    echo
    echo "[✓] Агент обновлён и запущен."
    echo "    Бинарник: $BIN_PATH"
  else
    systemctl --no-pager --full status madagent || true
    echo
    echo "[!] Бинарник обновлён, но сервис не запустился (см. лог / journalctl -u madagent)."
    echo "    Бинарник: $BIN_PATH"
    exit 1
  fi

  exit 0
fi

# ---- Обычная установка ----

if [[ -z "$NODE_ID" || -z "$NODE_TOKEN" ]]; then
  echo "Использование: $0 --node-id <id> --token <token> [--api-url <url>]"
  exit 1
fi

echo "[*] Установка агента MadHost для узла: $NODE_ID"
echo "[*] API URL (куда шлём метрики): $API_URL"

download_binary

echo "[*] Пишу конфиг в $CONFIG_PATH"
mkdir -p "$(dirname "$CONFIG_PATH")"

cat > "$CONFIG_PATH" <<EOF
{
  "api_url": "$API_URL",
  "node_id": "$NODE_ID",
  "token": "$NODE_TOKEN"
}
EOF

chmod 600 "$CONFIG_PATH"

echo "[*] Настраиваю systemd юнит в $UNIT_PATH"

cat > "$UNIT_PATH" <<'EOF'
[Unit]
Description=MadHost node metrics agent
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/usr/local/bin/madagent
Restart=always
RestartSec=5
Environment=MADAGENT_CONFIG=/etc/madagent.json
TimeoutStopSec=15

[Install]
WantedBy=multi-user.target
EOF

echo "[*] Перезапуск systemd daemon и запуск сервиса"
systemctl daemon-reload
systemctl enable --now madagent

sleep 2

if systemctl is-active --quiet madagent; then
  systemctl --no-pager --full status madagent || true
  echo
  echo "[✓] Агент установлен и запущен."
  echo "    Конфиг:   $CONFIG_PATH"
  echo "    Бинарник: $BIN_PATH"
else
  systemctl --no-pager --full status madagent || true
  echo
  echo "[!] Агент установлен, но не удалось запустить (см. лог выше / journalctl -u madagent)."
  echo "    Конфиг:   $CONFIG_PATH"
  echo "    Бинарник: $BIN_PATH"
  exit 1
fi
